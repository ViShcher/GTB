name: Telegram Full Repo Dump

on:
  push:
    branches:
      - "**"

jobs:
  dump:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare file list (tracked only)
        id: files
        run: |
          # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ð¾Ð´ git (Ð¸ÑÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð² .gitignore)
          git ls-files -z > tracked.txt

          # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸ÑÐ¼: Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ/ÐºÐ¾Ð½Ñ„Ð¸Ð³/ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ ÑÐ²Ð¾Ð¸ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸
          cat tracked.txt | tr '\0' '\n' | \
          grep -E '\.(py|pyi|txt|md|rst|toml|ini|cfg|conf|json|yml|yaml|toml|xml|csv|tsv|env\.example|sql|sh|bash|Dockerfile|procfile|gitignore|editorconfig)$|(^Dockerfile$)|(^Procfile$)|(^\.env\.example$)|(^Makefile$)' \
          > text_files.txt || true

          # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸ÑÐºÐ»ÑŽÑ‡Ð¸Ð¼ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ
          # (Ð²Ð´Ñ€ÑƒÐ³ ÐºÑ‚Ð¾-Ñ‚Ð¾ Ð½Ð°Ð·Ð²Ð°Ð» Ñ„Ð°Ð¹Ð» ÑÑ‚Ñ€Ð°Ð½Ð½Ð¾)
          grep -v -i -E '(^|/)\.env($|\.|/)|(^|/)secrets?($|/)|(^|/)token|(^|/)credentials?' text_files.txt > text_files_sanitized.txt || true

          echo "count=$(wc -l < text_files_sanitized.txt | tr -d ' ')" >> $GITHUB_OUTPUT

      - name: Build repo_dump.txt
        run: |
          OUT="repo_dump.txt"
          : > "$OUT"
          echo "# Repository dump for $GITHUB_REPOSITORY" >> "$OUT"
          echo "# Commit: $GITHUB_SHA" >> "$OUT"
          echo "# Branch: $GITHUB_REF_NAME" >> "$OUT"
          echo "# Pushed by: $GITHUB_ACTOR" >> "$OUT"
          echo "# Date (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')" >> "$OUT"
          echo "" >> "$OUT"

          while IFS= read -r file; do
            # ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ð¾Ð´Ð¸Ð½Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (>1.5MB) Ð½Ð° Ð²ÑÑÐºÐ¸Ð¹
            if [ -f "$file" ] && [ $(stat -c%s "$file") -le 1572864 ]; then
              echo "========================================" >> "$OUT"
              echo "FILE: $file" >> "$OUT"
              echo "----------------------------------------" >> "$OUT"
              # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ ÐºÐ°Ðº Ñ‚ÐµÐºÑÑ‚; ÐµÑÐ»Ð¸ Ð±Ð¸Ð½Ð°Ñ€ÑŒ â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼
              if file -bi "$file" | grep -qi 'charset='; then
                cat "$file" >> "$OUT"
              else
                echo "[skipped non-text or unknown encoding]" >> "$OUT"
              fi
              echo "" >> "$OUT"
            else
              echo "========================================" >> "$OUT"
              echo "FILE: $file" >> "$OUT"
              echo "----------------------------------------" >> "$OUT"
              echo "[skipped due to size >1.5MB or missing file]" >> "$OUT"
              echo "" >> "$OUT"
            fi
          done < text_files_sanitized.txt

          # ÐŸÐµÑ‡Ð°Ñ‚ÑŒ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð°
          du -h "$OUT"

      - name: Send to Telegram (split if large)
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          MAX_CHUNK=$((45 * 1024 * 1024))  # ~45MB Ð½Ð° ÐºÑƒÑÐ¾Ðº Ð´Ð»Ñ Ð·Ð°Ð¿Ð°ÑÐ°
          SIZE=$(stat -c%s repo_dump.txt)

          SUMMARY="ðŸ“¦ Full repo dump
Repo: $GITHUB_REPOSITORY
Branch: $GITHUB_REF_NAME
Commit: $GITHUB_SHA
Files: ${{ steps.files.outputs.count }}
Size: $(du -h repo_dump.txt | cut -f1)
Pusher: $GITHUB_ACTOR"

          # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ð¼ ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            --data-urlencode "text=${SUMMARY}" > /dev/null

          if [ "$SIZE" -le "$MAX_CHUNK" ]; then
            # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð´Ð½Ð¸Ð¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð¼
            curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
              -F chat_id="${TG_CHAT_ID}" \
              -F document="@repo_dump.txt" \
              -F caption="repo_dump.txt (Ð²ÐµÑÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð¾Ð´Ð½Ð¸Ð¼ Ñ„Ð°Ð¹Ð»Ð¾Ð¼)" > /dev/null
          else
            # Ð ÐµÐ¶ÐµÐ¼ Ð¸ ÑˆÐ»Ñ‘Ð¼ Ñ‡Ð°ÑÑ‚ÑÐ¼Ð¸
            split -b $MAX_CHUNK -d -a 2 repo_dump.txt repo_dump_part_
            for f in repo_dump_part_*; do
              curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
                -F chat_id="${TG_CHAT_ID}" \
                -F document="@$f" \
                -F caption="$f" > /dev/null
            done
          fi
